@using FilmReview.Models
@using FilmReview.Data
@using Microsoft.EntityFrameworkCore
@inject MyContext _context
<img src="@FilmsAndData.Film.FilmImageLink" />
<h1>@((float)FilmsAndData.Film.Summ / (float)FilmsAndData.Film.Total) </h1>
@if (FilmsAndData.isAdmin != null)
{
    <Div class="display-6">
        <Blazorise.Rating  TextColor="TextColor.Success" @bind-SelectedValue="@FilmsAndData.Rank" MaxValue="5" @onclick="RateFilm" />
    </Div>
}
<h4>О фильме: @FilmsAndData.Film.About</h4>
<h5>Тэги: @FilmsAndData.Film.Tags</h5>
<h5>Страна: @FilmsAndData.Film.Country | Год: @FilmsAndData.Film.Year </h5>
<h5>Длительность: @FilmsAndData.Film.Duration | MPAA: @FilmsAndData.Film.MPAA </h5>
@if (FilmsAndData.isAdmin != null)
{
    <Form>
         <FieldBody ColumnSize="ColumnSize.Is10">
             <TextEdit @bind-Text="TextComment" Placeholder="Комментарий..." />
         </FieldBody>
         <Button Color="Color.Primary" Clicked="Comment" Type="ButtonType.Submit" PreventDefaultOnSubmit>Отправить</Button>
 </Form>
    <br />
}
@if(Comments.FirstOrDefault()!=null)
{
    foreach (var comment in Comments)
    {
        <Card Background
        ="Background.Light" Style="width:600px">
            <CardTitle Size="3">
                @Users.FirstOrDefault(p => p.UserID == comment.UserID).NickName
            </CardTitle>
            <CardText>@comment.Text</CardText>
                <CardText>Likes: @comment.Likes | Dislikes: @comment.Dislikes</CardText>
                @if (FilmsAndData.isAdmin != null)
            {
                <Div TextAlignment="TextAlignment.End" Padding="Padding.Is1.FromEnd">
                    <Button Color="Color.Success" Clicked="@(()=>CommentEnable(comment.CommentID))" >
                        Ответить
                        <Icon Name="IconName.ArrowDown"></Icon>
                    </Button>
                </Div>
            }
        </Card>
        @if (CommentingOn == comment.CommentID)
        {
            <Form>
                <FieldBody ColumnSize="ColumnSize.Is10">
                    <TextEdit @bind-Text="TextSubComment" Placeholder="Комментарий к комментарию..." />
                </FieldBody>
                <Button Color="Color.Primary" Clicked="CommentOnComment" Type="ButtonType.Submit"            
    PreventDefaultOnSubmit
                 >Отправить</Button>
             </Form>
        }
        @if (SubComments.FirstOrDefault(p=>p.TrackingOn==comment.CommentID)!=null)
        {
            var CurrentSubComments = SubComments.Where(p => p.TrackingOn == comment.CommentID);
            @foreach (var subcomment in CurrentSubComments)
            {
                <Div Padding="Padding.Is5.FromStart">
                    <Card Background="Background.Light" Style="width:600px">
                        <CardTitle Size="3">
                            @Users.FirstOrDefault(p => p.UserID == subcomment.UserID).NickName
                        </CardTitle>
                        <CardText>Это сабкоммент</CardText>
                        <CardText>@subcomment.Text</CardText>
                            <Div TextAlignment="TextAlignment.End" Padding="Padding.Is1.FromEnd">
                            </Div>
                        </Card>
                    </Div>
            }
                <br />
        }


}
}
@code {
    [Parameter]
    public FilmsAndData FilmsAndData { get; set; }
    public List<Comments> Comments { get; set; } 
    public List<Comments> SubComments { get; set; }
    public IEnumerable<Users> Users { get; set; }
    int oldRank = 0;
    public bool pressed { get; set; }
    public string TextComment { get; set; } = "";
    public string TextSubComment { get; set; } = "";
    public int? CommentingOn { get; set; }
    protected override async Task OnInitializedAsync()
    {
        if (FilmsAndData.Rank != 0)
        {
            oldRank = FilmsAndData.Rank;
            pressed = true;
        }
        else pressed = false;
        var AllComments = _context.Comments.Where(p => p.FilmID == FilmsAndData.Film.FilmID).ToList();
        Comments = AllComments.Where(p => p.TrackingOn == null).ToList();
        SubComments = AllComments.Where(p => p.TrackingOn != null).ToList();
        Users = _context.Users.ToList();
    }
    private async Task RateFilm()
    {
        if (FilmsAndData.Rank > 0 && FilmsAndData.Rank < 6)
        {
            Reviews review = _context.Reviews.FirstOrDefault(p => p.ReviewID == FilmsAndData.ReviewID);
            if (review == null) review = new Reviews();
            review.UserID = (int)FilmsAndData.currentUserID;
            review.Rank =(int)FilmsAndData.Rank;
            Films film =_context.Films.FirstOrDefault(p=>p.FilmID==FilmsAndData.Film.FilmID);
            review.FilmID = FilmsAndData.Film.FilmID;
            if (FilmsAndData.ReviewID!= null||pressed==true)
            {
                film.Summ -= oldRank;
                film.Summ += review.Rank;
            }
            else
            {
                film.Total += 1;
                film.Summ += review.Rank;
                pressed = true;
                _context.Reviews.Add(review);
            }
            oldRank = FilmsAndData.Rank;
            FilmsAndData.Film = film;
            await _context.SaveChangesAsync();
        }
    }
    private async Task Comment()
    {
        if (TextComment != "")
        {
            Comments Comment = new Comments();
            Comment.Text = TextComment;
            Comment.Row = 0;
            Comment.Likes = 0;
            Comment.Dislikes = 0;
            Comment.FilmID=FilmsAndData.Film.FilmID;
            Comment.UserID =(int)FilmsAndData.currentUserID;
            TextComment = "";
            Comments.Add(Comment);
            _context.Comments.Add(Comment);
            await _context.SaveChangesAsync();
        }
    }
    private async Task CommentEnable(int CommentID)
    {
        CommentingOn = CommentID;
    }
    private async Task CommentOnComment()
    {
        if (TextSubComment != "")
        {
            Comments Comment = new Comments();
            Comment.Text = TextSubComment;
            Comment.Row = 1;
            Comment.Likes = 0;
            Comment.Dislikes = 0;
            Comment.FilmID = FilmsAndData.Film.FilmID;
            Comment.UserID = (int)FilmsAndData.currentUserID;
            Comment.TrackingOn=CommentingOn;
            TextSubComment = "";
            _context.Comments.Add(Comment);
            await _context.SaveChangesAsync();
            SubComments.Add(Comment);
        }
    }
}
